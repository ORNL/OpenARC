#! /bin/bash

VERIFY=0
MERGE=1
GRAPH=0
while [ "$1" != "" ]; do
    PARAM=`echo $1 | awk -F= '{print $1}'`
    VALUE=`echo $1 | awk -F= '{print $2}'`
    case $PARAM in
        VERIFY)
            VERIFY=1
            echo "==> Enable a verification mode"
            ;;  
        MERGE)
            MERGE=1
            echo "==> Merge adjacent IRIS tasks"
            ;;  
        NOMERGE)
            MERGE=0
            echo "==> Do not merge adjacent IRIS tasks"
            ;;  
        GRAPH)
            GRAPH=1
            echo "==> Submit IRIS task graph"
            ;;  
        *)  
            echo "ERROR: unknown parameter \"$PARAM\""
            exit 1
            ;;
    esac
    shift
done

verLevel=0
inputFile="gemm.c"

if [ "${OPENARC_INSTALL_ROOT}" = "" ]; then
    OPENARC_INSTALL_ROOT=${openarc}/install
fi
if [ ! -f "${OPENARC_INSTALL_ROOT}/make.header" ]; then
    echo "====> Cannot find OpenARC install directory; set environment variable, OPENARC_INSTALL_ROOT properly!"
    exit
fi

openarcinc="${OPENARC_INSTALL_ROOT}/include"
openarclib="${OPENARC_INSTALL_ROOT}/lib"
openarcbin="${OPENARC_INSTALL_ROOT}/bin"

if [ ! -f "openarcConf.txt" ]; then
    cp "openarcConf_NORMAL.txt" "openarcConf.txt"
fi

if [ ! -f "$inputFile" ]; then
	echo "====> [ERROR] cannot find the input file: ${inputFile}; exit!"
	exit	
fi

if [ "$openarcinc" != "" ]; then
    mv "openarcConf.txt" "openarcConf.txt_tmp"
    cat "openarcConf.txt_tmp" | sed "s|__openarcrt__|${openarcinc}|g" > "openarcConf.txt"
    rm "openarcConf.txt_tmp"
fi

if [ "$VERIFY" == "1" ]; then
    mv "openarcConf.txt" "openarcConf.txt_tmp"
    cat "openarcConf.txt_tmp" | sed "s|^macro=|&VERIFICATION=1,|g" > "openarcConf.txt"
    rm "openarcConf.txt_tmp"
fi

if [ "$MERGE" == "1" ]; then
    mv "openarcConf.txt" "openarcConf.txt_tmp"
    cat "openarcConf.txt_tmp" | sed "s|^macro=|&MERGE_TASKS,|g" > "openarcConf.txt"
    rm "openarcConf.txt_tmp"
fi

if [ "$GRAPH" == "1" ]; then
    mv "openarcConf.txt" "openarcConf.txt_tmp"
    cat "openarcConf.txt_tmp" | sed "s|^macro=|&GRAPH,|g" > "openarcConf.txt"
    rm "openarcConf.txt_tmp"
fi

java -classpath $openarclib/cetus.jar:$openarclib/antlr.jar openacc.exec.ACC2GPUDriver -verbosity=${verLevel} -gpuConfFile=openarcConf.txt $inputFile
echo ""
echo "====> To compile the translated output file:"
echo "\$ make"
echo ""
echo "====> To run the compiled binary:"
echo "\$ cd bin; gemm_ACC"
echo ""
echo "====> Available options:"
echo "-i <iterations>  Number of iterations (default: 1)"
echo "-d <devices>  Number of devices (default: 1)"
echo "-c <chunkSize>  Chunk Size"
echo "-m <numElements>  Number of array elements, _M_ (default: 1024)"
echo "-n <numElements>  Number of array elements, _N_ (default: 1024)"
echo "-k <numElements>  Number of array elements, _K_ (default: 1024)"
echo "-am <asyncMode>  Set the asynchronous Mode (default: 2)"
